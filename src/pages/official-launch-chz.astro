---
import Analytics from "@vercel/analytics/astro";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>$CHZ Launchpad | Official Admin</title>
    <style>
      :root {
        color-scheme: dark;
        --bg: #050309;
        --fire: #ff7930;
        --gold: #ffd166;
        --text: #f7f7ff;
        font-family: "Segoe UI", system-ui, sans-serif;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background-image: radial-gradient(circle at top, rgba(255, 111, 28, 0.1), transparent 70%);
      }

      .card {
        max-width: 550px;
        width: 90%;
        background: rgba(17, 10, 26, 0.9);
        padding: 2.5rem;
        border-radius: 24px;
        border: 1px solid rgba(255, 121, 48, 0.2);
        box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      }

      h1 { text-align: center; color: var(--fire); margin: 0 0 1.5rem; letter-spacing: 1px; }

      .status-box {
        background: #000;
        padding: 1rem;
        border-radius: 12px;
        font-family: monospace;
        font-size: 0.8rem;
        border: 1px solid rgba(255,255,255,0.1);
        margin: 1.5rem 0;
        height: 180px;
        overflow-y: auto;
      }

      .btn {
        width: 100%;
        padding: 1rem;
        border-radius: 12px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        transition: 0.2s;
        margin-bottom: 1rem;
        text-transform: uppercase;
      }

      .btn-primary {
        background: var(--fire);
        color: #000;
      }

      .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; }

      .btn-secondary { background: rgba(255,255,255,0.05); color: #fff; }

      .log-error { color: #ff4c20; }
      .log-success { color: #4caf50; }
      .log-info { color: #ffd166; }
    </style>
  </head>
  <body>
    <!-- 1. EXTREME POLYFILLS FOR METAPLEX -->
    <script is:inline>
      window.global = window;
      window.process = { env: {} };
      if (!window.Buffer) {
        window.Buffer = { isBuffer: () => false };
      }
      // Heavy polyfill for the Readable.prototype error
      if (typeof window.EventEmitter === 'undefined') {
        window.EventEmitter = function() {};
        window.EventEmitter.prototype.on = function() {};
        window.EventEmitter.prototype.emit = function() {};
      }
      // Mock stream if not present
      if (typeof window.ReadableStream === 'undefined') {
        window.ReadableStream = function() {};
      }
    </script>

    <div class="card">
      <h1>$CHZ ADMIN PANEL</h1>
      <p style="text-align: center; opacity: 0.7; font-size: 0.9rem;">Authority Only: <code>9Vsan6...5wP</code></p>

      <div class="status-box" id="console">
        <div style="color: #666;">> Direct Blockchain Access Ready.</div>
      </div>

      <button id="btn-connect" class="btn btn-secondary">1. Connect Authority Wallet</button>
      <button id="btn-brand" class="btn btn-primary" disabled>2. Register Name & Logo (FREE)</button>
      
      <p style="text-align: center; font-size: 0.75rem; opacity: 0.5; margin-top: 1rem;">
        CHZ Mint: <code>7pQ6NNrUN73n5xEFqczgG3Yox6ZzTzW5g7aYgC1EhkHe</code>
      </p>
    </div>

    <script>
      import { Buffer } from "buffer";
      window.Buffer = Buffer;
      globalThis.Buffer = Buffer;

      import { Connection, PublicKey } from "@solana/web3.js";
      
      const AUTHORIZED_WALLET = "9Vsan6w7QaGHDEbF1JcgruDVcbsS3xkEMgeZmAQGJ5wP";
      const MINT_ADDR = "7pQ6NNrUN73n5xEFqczgG3Yox6ZzTzW5g7aYgC1EhkHe";
      const METADATA_URI = "https://raw.githubusercontent.com/ninox3333/CharizardToken/main/public/metadata.json";

      const logConsole = document.getElementById('console');
      const btnConnect = document.getElementById('btn-connect');
      const btnBrand = document.getElementById('btn-brand');

      function log(msg, type = 'default') {
        const entry = document.createElement('div');
        entry.className = type === 'default' ? '' : `log-${type}`;
        entry.innerText = `> ${msg}`;
        logConsole.appendChild(entry);
        logConsole.scrollTop = logConsole.scrollHeight;
      }

      let wallet = null;

      btnConnect.onclick = async () => {
        log("Requesting Phantom connection...", "info");
        try {
          const { solana } = window;
          if (!solana?.isPhantom) {
            log("Phantom Wallet not found!", "error");
            return;
          }
          const resp = await solana.connect();
          wallet = resp.publicKey.toString();
          
          if (wallet !== AUTHORIZED_WALLET) {
            log(`UNAUTHORIZED WALLET: ${wallet.slice(0,6)}...`, "error");
            return;
          }

          log(`Authorized: ${wallet.slice(0,8)}...`, "success");
          btnConnect.innerText = "WALLET CONNECTED";
          btnBrand.disabled = false;
        } catch (e) { log(e.message, "error"); }
      };

      btnBrand.onclick = async () => {
        btnBrand.disabled = true;
        log("Accessing Token Registry...", "info");
        
        try {
          // CLEAN DYNAMIC IMPORTS
          const { createUmi } = await import("@metaplex-foundation/umi-bundle-defaults");
          const { walletAdapterIdentity } = await import("@metaplex-foundation/umi-signer-wallet-adapters");
          const { 
            createMetadataAccountV3, 
            mplTokenMetadata, 
            findMetadataPda 
          } = await import("@metaplex-foundation/mpl-token-metadata");
          const { publicKey: umiPublicKey, none } = await import("@metaplex-foundation/umi");
          const { fromWeb3JsPublicKey } = await import("@metaplex-foundation/umi-web3js-adapters");

          log("Connecting to Solana Global Network...", "info");
          const umi = createUmi("https://solana-rpc.publicnode.com")
            .use(mplTokenMetadata())
            .use(walletAdapterIdentity(window.solana));

          const mint = umiPublicKey(MINT_ADDR);
          const metadata = findMetadataPda(umi, { mint });

          log("Building Registration Packet...", "info");
          const transaction = createMetadataAccountV3(umi, {
            metadata,
            mint,
            mintAuthority: umi.identity,
            payer: umi.identity,
            updateAuthority: fromWeb3JsPublicKey(new PublicKey(AUTHORIZED_WALLET)),
            data: {
              name: "Charizard Token",
              symbol: "CHZ",
              uri: METADATA_URI,
              sellerFeeBasisPoints: 0,
              creators: none(),
              collection: none(),
              uses: none(),
            },
            isMutable: true,
            collectionDetails: none(),
          });

          log("APPROVE IN PHANTOM (FREE - Only Gas Fees)", "success");
          const result = await transaction.sendAndConfirm(umi);
          
          log("ðŸ”¥ BRANDING COMPLETE! YOUR TOKEN IS OFFICIAL.", "success");
          log("Check Solscan in a few minutes.", "info");
          btnBrand.innerText = "REGISTERED";
        } catch (e) {
          log(`Fail: ${e.message}`, "error");
          console.error(e);
          btnBrand.disabled = false;
        }
      };
    </script>
  </body>
</html>
